import torch
import torch.nn as nn
import torch.nn.functional as F

class StrokeEncoder(nn.Module):
    def __init__(
        self, 
        input_dim = 4,
        hidden_size = 512, 
        latent_dim = 256, 
        num_layers = 2
    ):
        super().__init__()
        
        # Bi-directional LSTM to process the sequence from both directions
        self.model = nn.LSTM(
            input_size = input_dim,
            hidden_size = hidden_size,
            num_layers = num_layers,
            bidirectional = True,
            batch_first = True
        )
        
        output_size = 2 * hidden_size
        
        self.mean_dist = nn.Linear(output_size, latent_dim)
        self.log_var = nn.Linear(output_size, latent_dim)

    def forward(self, stroke_seq):
        # stroke_seq shape: (batch_size, seq_len, 4)

        h_s = self.model(stroke_seq)[1][0] # Final hidden state

        final_forward = h_s[-2]
        final_backward = h_s[-1]
        final_state = torch.cat([final_forward, final_backward], dim = 1)

        mean_dist = self.mean_dist(final_state)
        log_var = self.log_var(final_state)
        
        return mean_dist, log_var

    def reparameterize(self, mean_dist, log_var):
        # https://medium.com/data-science/reparameterization-trick-126062cfd3c3
        std = torch.exp(0.5 * log_var)
        eps = torch.randn_like(std)
        
        return mean_dist + eps * std
    
class StrokeDecoder(nn.Module):
    def __init__(
        self, 
        num_classes, 
        hidden_size = 512, 
        num_mixtures = 5
    ):
        super().__init__()

        CHAR_EMBED_DIM = 64 
        rnn_input_dim = 4 + 256 + CHAR_EMBED_DIM

        self.char_embed = nn.Embedding(num_classes, CHAR_EMBED_DIM)
        
        # Unidirectional LSTM for sequence generation
        self.rnn = nn.LSTM(
            input_size = rnn_input_dim,
            hidden_size = hidden_size,
            num_layers = 2,
            batch_first = True
        )
        
        mdn_output_dim = (6 * num_mixtures) + 2
        self.mdn_linear = nn.Linear(hidden_size, mdn_output_dim)
        
        self.num_mixtures = num_mixtures
        
    def forward(
        self, 
        char_ids, 
        z, 
        stroke_seq_input, 
        hidden_state = None
    ):
        # char_ids shape: (batch_size, 1)
        # z shape: (batch_size, 256)
        # stroke_seq_input shape: (batch_size, seq_len - 1, 4)
        
        char_embed = self.char_embed(char_ids)

        context_vector = torch.cat([char_embed, z], dim = 1)
        context_vector = context_vector.unsqueeze(1).repeat(1, stroke_seq_input.size(1), 1)
        
        model_input = torch.cat([stroke_seq_input, context_vector], dim = 2)
        
        model_output, hidden_state = self.rnn(model_input, hidden_state)
        
        mdn_params = self.mdn_linear(model_output)
        
        return mdn_params, hidden_state

class HandwritingModel(nn.Module):
    def __init__(
        self, 
        num_classes = 2, 
        latent_dim = 256, 
        hidden_size = 512, 
        num_mixtures = 5
    ):
        super().__init__()
        
        self.encoder = StrokeEncoder(
            latent_dim = latent_dim, 
            hidden_size = hidden_size
        )
        self.decoder = StrokeDecoder(
            num_classes = num_classes, 
            hidden_size = hidden_size, 
            num_mixtures = num_mixtures
        )

    def forward(self, stroke_seq, char_ids):
        # stroke_seq shape: (batch_size, seq_len, 4)
        
        mean_dist, log_var = self.encoder(stroke_seq)
        z = self.encoder.reparameterize(mean_dist, log_var)

        stroke_seq_input = stroke_seq[:, :-1, :]
        
        mdn_params = self.decoder(
            char_ids = char_ids, 
            z = z, 
            stroke_seq_input = stroke_seq_input
        )[0]
        
        return mdn_params, mean_dist, log_var

seq = [[129.0, 80.0, 0.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [29.0, -36.0, 0.0, 1.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 2.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 2.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 2.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [54.0, -134.0, 0.0, 1.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [10.0, -27.0, 0.0, 1.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [2.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, -1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-42.0, -5.0, 0.0, 1.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 2.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 2.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [-2.0, -55.0, 0.0, 1.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 2.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [-1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, -1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, -1.0, 1.0, 0.0], [67.0, -31.0, 0.0, 1.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [0.0, 1.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0], [1.0, 0.0, 1.0, 0.0]]
seq = torch.tensor(seq, dtype = torch.float32)
seq = seq.unsqueeze(0)

model = StrokeEncoder()
mean, log_var = model(seq)
z = model.reparameterize(mean, log_var)

model = HandwritingModel(num_classes = 3)

mdn_params, mean_dist, log_var = model(seq, 0)

print(f"MDN params {mdn_params.shape}", mdn_params)
print(f"Mean Dist {mean_dist.shape}", mean_dist)
print(f"Log Var {log_var.shape}", log_var)